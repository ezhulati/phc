---
/**
 * Best-in-Class Blog Layout
 * Professional article layout with optimal typography, reading experience, and responsive design
 *
 * Features:
 * - 65ch content width for optimal readability
 * - Fluid typography with proper hierarchy
 * - Reading progress indicator
 * - Sticky table of contents on desktop
 * - Full-bleed hero image option
 * - Author bio card
 * - Related posts grid
 * - Mobile-first responsive design
 *
 * Based on best practices from Smashing Magazine, Stripe, NN/g
 */

import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '@/components/common/Breadcrumbs.astro';
import TableOfContents from '@/components/blog/TableOfContents.astro';
import ReadingProgress from '@/components/blog/ReadingProgress.astro';
import ShareButtons from '@/components/blog/ShareButtons.astro';
import AuthorCard from '@/components/blog/AuthorCard.astro';
import RelatedPosts from '@/components/blog/RelatedPosts.astro';
import { getLangFromUrl, t } from '@/i18n/ui';
import { formatDate, calculateReadingTime } from '@/lib/utils/dates';
import { generateArticleSchema } from '@/lib/utils/schema';
import type { WPPost } from '@/lib/graphql/types';

interface Props {
  post: WPPost;
  relatedPosts?: WPPost[];
  showToc?: boolean;
  heroStyle?: 'default' | 'fullbleed' | 'minimal';
}

const {
  post,
  relatedPosts = [],
  showToc = true,
  heroStyle = 'default'
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const homeLabel = t(lang, 'nav.home');
const homeHref = lang === 'es' ? '/es/' : '/';

const title = post.seo?.title || post.title;
const description = post.seo?.metaDesc || post.excerpt?.replace(/<[^>]*>/g, '').slice(0, 160);
const canonicalUrl = `https://prosperahealthcare.com/${post.slug}/`;
const ogImage = post.seo?.opengraphImage?.sourceUrl || post.featuredImage?.node?.sourceUrl;

const breadcrumbs = [
  { name: homeLabel, href: homeHref },
  { name: post.title, href: `/${post.slug}/` },
];

const schema = generateArticleSchema(post, canonicalUrl);
const readingTime = calculateReadingTime(post.content, lang === 'es' ? 'es' : 'en');
const publishedDate = formatDate(post.date, lang === 'es' ? 'es' : 'en');
const modifiedDate = post.modified ? formatDate(post.modified, lang === 'es' ? 'es' : 'en') : null;
const authorName = post.author?.node?.name || 'Prospera Healthcare';
const authorBio = post.author?.node?.description || '';
const authorAvatar = post.author?.node?.avatar?.url || '/images/wp/prospera-logo.png';
const primaryCategory = post.categories?.nodes?.[0];
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonicalUrl}
  ogImage={ogImage}
  ogType="article"
  publishedTime={post.date}
  modifiedTime={post.modified}
  author={authorName}
  schema={schema}
>
  <!-- Reading Progress Indicator -->
  <ReadingProgress />

  <!-- Hero Section -->
  {heroStyle === 'fullbleed' && post.featuredImage?.node ? (
    <header class="relative min-h-[60vh] flex items-end">
      <div class="absolute inset-0">
        <img
          src={post.featuredImage.node.sourceUrl}
          alt={post.featuredImage.node.altText || post.title}
          class="w-full h-full object-cover"
          loading="eager"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-neutral-900/90 via-neutral-900/50 to-transparent"></div>
      </div>
      <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-12 lg:pb-16 w-full">
        <div class="mb-4">
          <Breadcrumbs items={breadcrumbs} variant="light" />
        </div>
        {primaryCategory && (
          <a
            href={`${lang === 'es' ? '/es/terapia-aba' : '/aba-therapy'}/${primaryCategory.slug}/`}
            class="inline-flex items-center min-h-[44px] px-4 text-sm font-medium text-white bg-primary-500 rounded-full no-underline hover:bg-primary-600 transition-colors mb-4"
          >
            {primaryCategory.name}
          </a>
        )}
        <h1 class="text-5xl font-bold text-white leading-tight mb-4 text-balance">
          {post.title}
        </h1>
        <div class="flex flex-wrap items-center gap-4 text-sm text-white/80">
          <div class="flex items-center gap-2">
            <img
              src={authorAvatar}
              alt={authorName}
              class="w-8 h-8 rounded-full border-2 border-white/30"
              width="32"
              height="32"
            />
            <span>{authorName}</span>
          </div>
          <span class="text-white/50">·</span>
          <time datetime={post.date}>{publishedDate}</time>
          <span class="text-white/50">·</span>
          <span>{readingTime}</span>
        </div>
      </div>
    </header>
  ) : (
    <header class="bg-neutral-50 border-b border-neutral-200">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
        <div class="mb-4">
          <Breadcrumbs items={breadcrumbs} />
        </div>
        {primaryCategory && (
          <a
            href={`${lang === 'es' ? '/es/terapia-aba' : '/aba-therapy'}/${primaryCategory.slug}/`}
            class="inline-flex items-center min-h-[44px] px-4 text-sm font-medium text-primary-700 bg-primary-100 rounded-full no-underline hover:bg-primary-200 transition-colors mb-4"
          >
            {primaryCategory.name}
          </a>
        )}
        <h1 class="text-5xl font-bold text-neutral-900 leading-tight mb-6 text-balance">
          {post.title}
        </h1>
        <div class="flex flex-wrap items-center gap-4 text-sm text-neutral-600">
          <div class="flex items-center gap-3">
            <img
              src={authorAvatar}
              alt={authorName}
              class="w-10 h-10 rounded-full"
              width="40"
              height="40"
            />
            <div>
              <div class="font-medium text-neutral-900">{authorName}</div>
              <div class="text-neutral-500">{publishedDate} · {readingTime}</div>
            </div>
          </div>
        </div>
      </div>
    </header>
  )}

  <!-- Main Content Area -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
    <div class="lg:grid lg:grid-cols-12 lg:gap-12">

      <!-- Article Content -->
      <article class="lg:col-span-8 xl:col-span-9">

        <!-- Featured Image (default/minimal style) -->
        {heroStyle !== 'fullbleed' && post.featuredImage?.node && (
          <figure class="mb-8 lg:mb-12 -mx-4 sm:mx-0">
            <img
              src={post.featuredImage.node.sourceUrl}
              alt={post.featuredImage.node.altText || post.title}
              class="w-full h-auto sm:rounded-xl"
              width={post.featuredImage.node.mediaDetails?.width}
              height={post.featuredImage.node.mediaDetails?.height}
              loading="eager"
            />
            {post.featuredImage.node.caption && (
              <figcaption class="mt-3 text-sm text-neutral-500 text-center px-4 sm:px-0">
                {post.featuredImage.node.caption}
              </figcaption>
            )}
          </figure>
        )}

        <!-- Article Body -->
        <div
          id="article-content"
          class="article-content prose prose-lg max-w-none
            prose-headings:text-neutral-900 prose-headings:font-bold prose-headings:scroll-mt-24
            prose-h2:text-2xl prose-h2:md:text-3xl prose-h2:mt-12 prose-h2:mb-6
            prose-h3:text-xl prose-h3:md:text-2xl prose-h3:mt-8 prose-h3:mb-4
            prose-h4:text-lg prose-h4:md:text-xl prose-h4:mt-6 prose-h4:mb-3
            prose-p:text-neutral-700 prose-p:leading-relaxed prose-p:mb-6
            prose-a:text-primary-600 prose-a:font-medium prose-a:underline prose-a:underline-offset-2 hover:prose-a:text-primary-700
            prose-strong:text-neutral-900 prose-strong:font-semibold
            prose-ul:my-6 prose-ol:my-6
            prose-li:text-neutral-700 prose-li:mb-2 prose-li:marker:text-primary-500
            prose-blockquote:border-l-4 prose-blockquote:border-primary-500 prose-blockquote:bg-primary-50 prose-blockquote:py-4 prose-blockquote:px-6 prose-blockquote:rounded-r-lg prose-blockquote:not-italic prose-blockquote:text-neutral-700
            prose-img:rounded-xl prose-img:mx-auto prose-img:shadow-md
            prose-code:text-primary-700 prose-code:bg-primary-50 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
            prose-pre:bg-neutral-900 prose-pre:rounded-xl prose-pre:shadow-lg
            prose-hr:border-neutral-200 prose-hr:my-12
            prose-table:text-sm prose-th:bg-neutral-100 prose-th:font-semibold
          "
          set:html={post.content}
        />

        <!-- Tags -->
        {post.tags?.nodes && post.tags.nodes.length > 0 && (
          <div class="mt-12 pt-8 border-t border-neutral-200">
            <h3 class="text-sm font-bold text-neutral-500 uppercase tracking-wider mb-4">
              {lang === 'es' ? 'Temas' : 'Topics'}
            </h3>
            <div class="flex flex-wrap gap-2">
              {post.tags.nodes.map((tag) => (
                <span class="px-4 py-2 text-sm font-medium text-neutral-700 bg-neutral-100 rounded-full hover:bg-neutral-200 transition-colors">
                  {tag.name}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Share Buttons (Mobile) -->
        <div class="mt-8 lg:hidden">
          <ShareButtons
            url={canonicalUrl}
            title={post.title}
            description={description || ''}
          />
        </div>

        <!-- Author Card -->
        <AuthorCard
          name={authorName}
          bio={authorBio}
          avatar={authorAvatar}
          class="mt-12"
        />

      </article>

      <!-- Sidebar (Desktop) -->
      <aside class="hidden lg:block lg:col-span-4 xl:col-span-3">
        <div class="sticky top-24 space-y-8">

          <!-- Table of Contents -->
          {showToc && (
            <TableOfContents content={post.content} lang={lang} />
          )}

          <!-- Share Buttons -->
          <ShareButtons
            url={canonicalUrl}
            title={post.title}
            description={description || ''}
            layout="vertical"
          />

          <!-- Newsletter CTA -->
          <div class="bg-primary-50 rounded-xl p-6 border border-primary-100">
            <h3 class="font-bold text-neutral-900 mb-2">
              {lang === 'es' ? 'Recursos gratuitos' : 'Free resources'}
            </h3>
            <p class="text-sm text-neutral-600 mb-4">
              {lang === 'es'
                ? 'Obtenga consejos de expertos sobre terapia ABA.'
                : 'Get expert tips on ABA therapy.'}
            </p>
            <a
              href={lang === 'es' ? '/es/contacto/' : '/contact/'}
              class="inline-flex items-center justify-center w-full px-4 py-2.5 bg-primary-500 hover:bg-primary-600 text-white font-medium rounded-lg transition-colors no-underline"
            >
              {lang === 'es' ? 'Contáctenos' : 'Contact us'}
            </a>
          </div>

        </div>
      </aside>

    </div>
  </div>

  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <RelatedPosts posts={relatedPosts} lang={lang} />
  )}

  <!-- Back to Top Button -->
  <button
    id="back-to-top"
    class="fixed bottom-6 right-6 w-12 h-12 bg-neutral-900 hover:bg-neutral-800 text-white rounded-full shadow-lg opacity-0 invisible transition-all duration-300 flex items-center justify-center z-50"
    aria-label="Back to top"
  >
    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
  </button>

</BaseLayout>

<style>
  /* Article content typography refinements */
  .article-content {
    /* Optimal line length for readability */
    --tw-prose-body: theme('colors.neutral.700');
    --tw-prose-headings: theme('colors.neutral.900');

    /* First paragraph - slightly larger (drop cap alternative) */
    & > p:first-of-type {
      font-size: 1.25em;
      line-height: 1.6;
      color: theme('colors.neutral.800');
    }

    /* Ensure proper spacing for embedded content */
    & iframe,
    & video,
    & .wp-block-embed {
      width: 100%;
      border-radius: 0.75rem;
      margin: 2rem 0;
    }

    /* Pull quotes */
    & .pullquote,
    & .wp-block-pullquote {
      font-size: 1.5em;
      font-weight: 500;
      line-height: 1.4;
      text-align: center;
      border: none;
      padding: 2rem 0;
      margin: 2rem 0;
      color: theme('colors.primary.700');
    }

    /* Image captions */
    & figcaption {
      text-align: center;
      font-size: 0.875rem;
      color: theme('colors.neutral.500');
      margin-top: 0.75rem;
    }

    /* Table styling */
    & table {
      width: 100%;
      border-collapse: collapse;
      margin: 2rem 0;
    }

    & th, & td {
      padding: 0.75rem 1rem;
      border: 1px solid theme('colors.neutral.200');
    }

    & th {
      background: theme('colors.neutral.100');
      font-weight: 600;
      text-align: left;
    }

    & tr:nth-child(even) {
      background: theme('colors.neutral.50');
    }
  }

  /* Smooth scroll anchor offset for sticky header */
  .article-content h2[id],
  .article-content h3[id],
  .article-content h4[id] {
    scroll-margin-top: 6rem;
  }
</style>

<script>
  // Back to top button visibility
  const backToTop = document.getElementById('back-to-top');

  if (backToTop) {
    window.addEventListener('scroll', () => {
      if (window.scrollY > 500) {
        backToTop.classList.remove('opacity-0', 'invisible');
        backToTop.classList.add('opacity-100', 'visible');
      } else {
        backToTop.classList.add('opacity-0', 'invisible');
        backToTop.classList.remove('opacity-100', 'visible');
      }
    });

    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
</script>
